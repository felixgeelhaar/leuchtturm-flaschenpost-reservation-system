---
import Layout from '@/layouts/Layout.astro';
import ReservationForm from '@/components/ReservationForm.vue';
import ConsentBanner from '@/components/ConsentBanner.vue';
import { DatabaseService } from '@/lib/database';

// Fetch magazines on the server
const db = new DatabaseService();
let magazines = [];

try {
  magazines = await db.getActiveMagazines();
} catch (error) {
  console.error('Failed to load magazines:', error);
  // Continue with empty array - component will handle the error
}
---

<Layout 
  title="Flaschenpost Magazin reservieren - Das Magazin für neugierige Eltern"
  description="Reservieren Sie Ihr Exemplar des Flaschenpost Magazins. Das Magazin für neugierige Eltern und ihre Kinder - voller spannender Experimente, Geschichten und Entdeckungen."
>
  <!-- Hero Section -->
  <section class="bg-gradient-to-br from-primary-50 to-secondary-50 py-12 sm:py-16 lg:py-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center max-w-3xl mx-auto">
        <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold text-neutral-900 mb-6">
          Flaschenpost Magazin
          <span class="block text-primary-600">für neugierige Familien</span>
        </h1>
        <p class="text-xl sm:text-2xl text-neutral-600 mb-8 leading-relaxed">
          Entdecken Sie gemeinsam mit Ihren Kindern die Welt der Wissenschaft, 
          Natur und Kreativität. Jede Ausgabe voller spannender Experimente und Geschichten.
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
          <a 
            href="#reservation-form" 
            class="btn-primary btn-lg w-full sm:w-auto"
            onclick="document.getElementById('reservation-form').scrollIntoView({ behavior: 'smooth' })"
          >
            Jetzt reservieren
          </a>
          <a 
            href="#about-magazine" 
            class="btn-outline btn-lg w-full sm:w-auto"
          >
            Mehr erfahren
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Magazine Info Section -->
  <section id="about-magazine" class="py-16 lg:py-20 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
        <!-- Content -->
        <div class="space-y-6">
          <h2 class="text-3xl sm:text-4xl font-bold text-neutral-900">
            Was macht Flaschenpost besonders?
          </h2>
          <div class="space-y-4 text-lg text-neutral-600">
            <p>
              Flaschenpost ist mehr als nur ein Magazin – es ist Ihr Begleiter für 
              gemeinsame Entdeckungsreisen mit der ganzen Familie.
            </p>
            <ul class="space-y-3">
              <li class="flex items-start space-x-3">
                <svg class="h-6 w-6 text-primary-600 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <span><strong>Einfache Experimente</strong> mit Haushaltsgegenständen</span>
              </li>
              <li class="flex items-start space-x-3">
                <svg class="h-6 w-6 text-primary-600 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <span><strong>Altersgerechte Erklärungen</strong> für Kinder von 6-12 Jahren</span>
              </li>
              <li class="flex items-start space-x-3">
                <svg class="h-6 w-6 text-primary-600 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <span><strong>Praktische Tipps</strong> für Eltern und Pädagogen</span>
              </li>
              <li class="flex items-start space-x-3">
                <svg class="h-6 w-6 text-primary-600 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <span><strong>Nachhaltige Materialien</strong> und umweltbewusste Inhalte</span>
              </li>
            </ul>
          </div>
        </div>
        
        <!-- Image -->
        <div class="relative">
          <img 
            src="/images/flaschenpost-family-reading.jpg" 
            alt="Familie beim gemeinsamen Lesen des Flaschenpost Magazins"
            class="rounded-lg shadow-lg w-full h-auto"
            width="600"
            height="400"
            loading="lazy"
          />
          <div class="absolute -bottom-6 -right-6 bg-primary-600 text-white p-4 rounded-lg shadow-lg">
            <div class="text-center">
              <div class="text-2xl font-bold">4.8★</div>
              <div class="text-sm">Bewertung von Eltern</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Current Issues Section -->
  {magazines.length > 0 && (
    <section class="py-16 lg:py-20 bg-neutral-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h2 class="text-3xl sm:text-4xl font-bold text-neutral-900 mb-4">
            Aktuelle Ausgaben
          </h2>
          <p class="text-xl text-neutral-600 max-w-2xl mx-auto">
            Entdecken Sie unsere neuesten Ausgaben voller spannender Themen und Experimente.
          </p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {magazines.slice(0, 3).map((magazine) => (
            <div class="card card-hover">
              <div class="aspect-[3/4] relative mb-4">
                <img 
                  src={magazine.coverImageUrl || '/images/placeholder-magazine-cover.jpg'}
                  alt={`${magazine.title} Ausgabe ${magazine.issueNumber}`}
                  class="w-full h-full object-cover rounded-t-lg"
                  loading="lazy"
                />
                {magazine.availableCopies > 0 ? (
                  <div class="absolute top-4 right-4 bg-success-500 text-white px-2 py-1 rounded text-sm font-medium">
                    {magazine.availableCopies} verfügbar
                  </div>
                ) : (
                  <div class="absolute top-4 right-4 bg-error-500 text-white px-2 py-1 rounded text-sm font-medium">
                    Ausverkauft
                  </div>
                )}
              </div>
              <div class="card-body">
                <h3 class="text-xl font-semibold text-neutral-900 mb-2">
                  {magazine.title}
                </h3>
                <div class="text-sm text-neutral-500 mb-2">
                  Ausgabe {magazine.issueNumber} • {new Date(magazine.publishDate).toLocaleDateString('de-DE', { year: 'numeric', month: 'long' })}
                </div>
                <p class="text-neutral-600 mb-4 line-clamp-3">
                  {magazine.description}
                </p>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-neutral-500">
                    {magazine.totalCopies} Exemplare
                  </span>
                  {magazine.availableCopies > 0 && (
                    <a 
                      href="#reservation-form" 
                      class="btn-primary btn-sm"
                      onclick="document.getElementById('magazineId').value = '{magazine.id}'; document.getElementById('reservation-form').scrollIntoView({ behavior: 'smooth' })"
                    >
                      Reservieren
                    </a>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Reservation Form Section -->
  <section id="reservation-form" class="py-16 lg:py-20 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h2 class="text-3xl sm:text-4xl font-bold text-neutral-900 mb-4">
          Ihr Exemplar reservieren
        </h2>
        <p class="text-xl text-neutral-600 max-w-2xl mx-auto">
          Füllen Sie das Formular aus, um Ihr Exemplar des Flaschenpost Magazins zu reservieren. 
          Die Reservierung ist kostenlos und unverbindlich.
        </p>
      </div>
      
      <ReservationForm 
        client:load 
        magazines={magazines}
        transition:persist
      />
    </div>
  </section>

  <!-- FAQ Section -->
  <section class="py-16 lg:py-20 bg-neutral-50">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h2 class="text-3xl sm:text-4xl font-bold text-neutral-900 mb-4">
          Häufige Fragen
        </h2>
        <p class="text-xl text-neutral-600">
          Antworten auf die wichtigsten Fragen zur Reservierung
        </p>
      </div>
      
      <div class="space-y-6">
        <details class="card p-6">
          <summary class="font-semibold text-lg text-neutral-900 cursor-pointer hover:text-primary-600 transition-colors">
            Ist die Reservierung kostenpflichtig?
          </summary>
          <div class="mt-4 text-neutral-600">
            <p>
              Nein, die Reservierung ist völlig kostenlos und unverbindlich. 
              Sie zahlen nur, wenn Sie das Magazin bei der Abholung erhalten.
            </p>
          </div>
        </details>
        
        <details class="card p-6">
          <summary class="font-semibold text-lg text-neutral-900 cursor-pointer hover:text-primary-600 transition-colors">
            Wie lange ist meine Reservierung gültig?
          </summary>
          <div class="mt-4 text-neutral-600">
            <p>
              Ihre Reservierung ist 7 Tage gültig. Sie erhalten eine E-Mail-Bestätigung 
              mit allen Details und können das Magazin in dieser Zeit an Ihrem gewählten Abholort abholen.
            </p>
          </div>
        </details>
        
        <details class="card p-6">
          <summary class="font-semibold text-lg text-neutral-900 cursor-pointer hover:text-primary-600 transition-colors">
            Kann ich meine Reservierung stornieren?
          </summary>
          <div class="mt-4 text-neutral-600">
            <p>
              Ja, Sie können Ihre Reservierung jederzeit stornieren. 
              Kontaktieren Sie uns einfach per E-Mail oder lassen Sie die Reservierung auslaufen.
            </p>
          </div>
        </details>
        
        <details class="card p-6">
          <summary class="font-semibold text-lg text-neutral-900 cursor-pointer hover:text-primary-600 transition-colors">
            Welche Daten werden gespeichert?
          </summary>
          <div class="mt-4 text-neutral-600">
            <p>
              Wir speichern nur die für die Reservierung notwendigen Daten (Name, E-Mail, Abholort). 
              Alle Daten werden DSGVO-konform verarbeitet und nach einem Jahr automatisch gelöscht. 
              Details finden Sie in unserer <a href="/privacy" class="text-primary-600 hover:text-primary-700 underline">Datenschutzerklärung</a>.
            </p>
          </div>
        </details>
        
        <details class="card p-6">
          <summary class="font-semibold text-lg text-neutral-900 cursor-pointer hover:text-primary-600 transition-colors">
            Gibt es das Magazin auch digital?
          </summary>
          <div class="mt-4 text-neutral-600">
            <p>
              Derzeit bieten wir Flaschenpost nur als gedrucktes Magazin an. 
              Wir arbeiten an einer digitalen Version, die in Zukunft verfügbar sein wird.
            </p>
          </div>
        </details>
      </div>
    </div>
  </section>

  <!-- Trust Indicators -->
  <section class="py-12 bg-white border-t border-neutral-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-8 text-center">
        <div class="space-y-2">
          <div class="text-2xl font-bold text-primary-600">1000+</div>
          <div class="text-sm text-neutral-600">Zufriedene Familien</div>
        </div>
        <div class="space-y-2">
          <div class="text-2xl font-bold text-primary-600">4.8★</div>
          <div class="text-sm text-neutral-600">Bewertung</div>
        </div>
        <div class="space-y-2">
          <div class="text-2xl font-bold text-primary-600">DSGVO</div>
          <div class="text-sm text-neutral-600">Konform</div>
        </div>
        <div class="space-y-2">
          <div class="text-2xl font-bold text-primary-600">7 Tage</div>
          <div class="text-sm text-neutral-600">Gültigkeitsdauer</div>
        </div>
      </div>
    </div>
  </section>

  <!-- GDPR Consent Banner -->
  <ConsentBanner 
    client:idle
    isVisible={true}
  />
</Layout>

<style>
  /* Line clamp utility for magazine descriptions */
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  /* Smooth scrolling for anchor links */
  html {
    scroll-behavior: smooth;
  }
  
  /* Details/summary styling */
  details > summary {
    list-style: none;
  }
  
  details > summary::before {
    content: '+';
    display: inline-block;
    width: 1em;
    margin-right: 0.5em;
    transition: transform 0.2s ease;
  }
  
  details[open] > summary::before {
    transform: rotate(45deg);
  }
  
  details > summary::-webkit-details-marker {
    display: none;
  }
</style>

<script>
  // Enhanced scroll behavior for better UX
  document.addEventListener('DOMContentLoaded', () => {
    // Smooth scroll for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });
    
    // Add scroll spy for navigation
    const sections = document.querySelectorAll('section[id]');
    const navLinks = document.querySelectorAll('nav a[href^="#"]');
    
    function updateActiveNav() {
      let current = '';
      sections.forEach(section => {
        const sectionTop = section.offsetTop;
        if (pageYOffset >= sectionTop - 60) {
          current = section.getAttribute('id');
        }
      });
      
      navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href').substring(1) === current) {
          link.classList.add('active');
        }
      });
    }
    
    window.addEventListener('scroll', updateActiveNav);
  });
</script>